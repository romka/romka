{{ $gallery := . }}

{{ $lines := split $gallery.RawContent "\n" }}
{{ $map := dict }}
{{ range $lines }}
    {{ $descr := split . ";" }}
    {{ $map = merge $map (dict (index $descr 0) (index $descr 1)) }}
{{ end }}

<div class="col-md-12 col-lg-12{{ if .Draft }} draft{{ end }}">
    <article>
        <div class="post_text post_text_top_radius">
            <div class="post_meta_top">
                {{- partial "partials/shared/tags.html" . -}}
                {{- partial "partials/shared/date.html" . -}}
            </div>
            <h4 class="post_title"><a href="{{ .RelPermalink | relURL }}">{{ .Title }}</a></h4>

            <div class="post_img {{ if .Draft }} draft{{ end }}">
                <div class="masonry-gallery">
                    <div class="grid-sizer"></div>
                    <div class="title-gallery" style="text-align: center">
                        {{- $photosCount := (or .Params.summary_photos_count 10) -}}
                        {{- range first $photosCount ($gallery.Resources.ByType "image") -}}
                            {{- $preview := .Fit "970x728 q90" -}}
                            {{- $thumb := .Fit "96x76" -}}
                            {{- $image := .Fit "1920x1920 q90" -}}
                            {{- $originalImage := . -}}
                            {{- with .Exif -}}
                                {{- if eq 6 .Tags.Orientation -}}
                                    {{- $image = $originalImage.Fit "1920x1920 q90 r270" -}}
                                {{- else if eq 8 .Tags.Orientation -}}
                                    {{- $image = $originalImage.Fit "1920x1920 q90 r90" -}}
                                {{- end -}}
                                {{- $preview = $image.Fit "970x728 q100" -}}
                                {{- $thumb = $image.Fit "96x76 q100" -}}
                            {{- end -}}

                            {{- $title := index $map .Name -}}
                        <figure data-src="{{ $image.RelPermalink | relURL }}" data-thumb="{{ $thumb.RelPermalink | relURL }}" class="grid-item">
                            <img src="{{ $preview.RelPermalink | relURL }}" alt="{{ $title }}">
                        </figure>
                        {{- end -}}
                    </div>
                </div>
            </div>
            <div class="post_nav"><a href="{{ .RelPermalink | relURL }}" class="link-arrow">{{ i18n "fullGallery" }} âž </a></div>
        </div>
    </article>
</div>