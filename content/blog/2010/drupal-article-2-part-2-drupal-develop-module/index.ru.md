---
title: Разработка модуля для Drupal. Часть2
date: 2010-01-03 18:31:40 +0300
draft: false
tags: [old-site, Drupal, модуль, статья]
---
## currencies.info

В .info-файлах модулей содержится служебная информация, без которой модуль не будет виден в системе. Начинаться любой .info-файл должен со строки
```
; $Id$
```
В файлах с PHP-кодом после открывающего тега <?php необходимо добавить строку
```
// $Id$
```
Эту строку, если модуль будет размещен в официальном <a href="http://ru.wikipedia.org/wiki/Система_управления_версиями">CVS-репозитории</a> Drupal, заменит служебная информация. Далее в файле .info должны располагаться три обязательных параметра: название модуля, его описание и версия ядра Drupal, с которой работает модуль. Кроме того, в этом файле могут находиться необязательные параметры: минимальная версия PHP, необходимая для запуска модуля, зависимость от других модулей Drupal, без которых текущий модуль не будет работать, и пр. Подробное описание всех доступных к использованию в .info-файле параметров можно найти в официальной документации (ссылка на эту и другие цитируемые в статье страницы документации размещена во врезке «Ссылки на документацию»).

В нашем случае файл _currencies.info_ будет иметь такой вид:
```
; $Id$
name = Currencies block
description = Show currencies
core = 6.x
```

## Административный интерфейс
Теперь приступим к реализации каждого из описанных этапов. Для начала добавим в наш файл _currencies.module_ функцию с реализацией хука _hook_perm_, который, как сказано выше, определяет дополнительные права доступа. Hook_perm — один из самых простых хуков, он всего лишь возвращает массив строк, представляющих собой права доступа. После инсталляции модуля администратор сайта на странице Admin — Permissions (_admin/user/permissions_) может указать, какие группы пользователей имеют право доступа _access currencies block settings_, а мы в дальнейшем, во время реализации формы настроек модуля при помощи функции <a href="http://api.drupal.org/api/function/user_access/6">user_access</a>, будем проверять, имеет ли текущий пользователь право доступа _access currencies block settings_ или нет.
```
function currencies_perm() {
    return array('access currencies block settings');
}
```
Важный момент. Пользователь с uid=1, т. е. первый созданный в системе, является суперпользователем, для него функция _user_access_ всегда возвращает значение TRUE, а это значит, что он всегда имеет доступ ко всем функциям сайта. Это одна из причин, почему не рекомендуется работать в системе с учетной записью суперпользователя: зачастую разработчики забывают раздавать пользователям необходимые права доступа, так как сами, работая как суперпользователи, не имеют проблем с доступом к ресурсам сайта.

Для определения дополнительного системного пути, по которому в нашем примере будет доступна страница управления модулем, необходимо создать реализацию хука _hook_menu_:
```
function currencies_menu() {
    $items = array();
    $items['admin/settings/cur-block'] = array(
        'title' => t('Currencies block settings'),
        'description' => 'Currencies block settings.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('currencies_settings'),
        'access arguments' => array('access cur block settings'),
    );
    return $items;
}
```
Эта функция также возвращает ассоциативный массив. Ключом каждого элемента массива должен быть путь, регистрируемый в системе (в нашем случае это _admin/settings/cur-block_), а значением — вложенный массив, содержащий информацию о создаваемом пункте меню. Давайте разберем каждый из параметров отдельно.

_**Title**_ — заголовок меню — будет использоваться при переходе на страницу с адресом _admin/settings/cur-block_ в строке заголовка браузера (тег `<title>`) и в качестве заголовка страницы (тег `<h1>`), а также в качестве текста ссылки, ведущей на созданную страницу настроек.

_**Description**_ — описание пункта меню, которое в нашем случае будет использоваться на странице администрирования.

_**Page callback**_ — функция, которая будет генерировать страницу, создаваемую по указанному пути. В простом случае значением этого параметра должна быть функция, возвращающая HTML-код, который будет показан пользователю. Однако мы по указанному адресу создаем не обычную страницу, а форму, значения которой автоматически сохраняются в БД. Поэтому для параметра page callback мы назначаем вызов системной функции [drupal_get_form](http://api.drupal.org/api/function/drupal_get_form/6)(), которая выведет на экран форму, созданную функцией с именем, указанным в элементе массива _page arguments_; в нашем случае это функция _currencies_settings()_. Функция _currencies_settings()_ должна вернуть ассоциативный массив, содержащий информацию об элементах создаваемой формы. Подробнее об этом массиве будет рассказано ниже.

_**Access arguments**_ — массив «прав доступа». Пользователи, обладающие правами доступа, перечисленными в этом массиве, могут получить доступ к создаваемому пункту меню. Более подробную информацию о параметрах пунктов меню можно найти в документации.

Сейчас в нашем модуле определен новый пункт меню, но не определена функция, формирующая содержимое страницы, на которую этот пункт указывает (см. листинг 2).

**Листинг 2**
```
function currencies_settings() {
    $form['currencies_list'] = array(
        '#type' => 'textfield',
        '#title' => t('Currencies'),
        '#default_value' => variable_get('currencies_list', "USD,EUR,CNY,BYR,KZT,TRY,UAH,JPY"),
        '#maxlength' => 255,
    );
    $form['currencies_list_freq'] = array(
        '#type' => 'textfield',
        '#title' => t('Frequency of updating of the data (in seconds)'),
        '#default_value' => variable_get('currencies_list_freq', 3600),
        '#maxlength' => 255,
        '#description' => t('It is recommended to use value not less than 3600.'),
    );
    $form['currencies_list_url'] = array(
        '#type' => 'textfield',
        '#title' => t('Адрес xml-файла'),
        '#default_value' => variable_get('currencies_list_url', "http://www.cbr.ru/scripts/XML_daily.asp?date_req=%d/%m/%y"),
        '#maxlength' => 255,
        '#description' => t('The XML-file address.'),
    );
    return system_settings_form($form);
}
```
Как и хуки [hook_menu](http://api.drupal.org/api/function/hook_menu/6), [hook_schema](http://api.drupal.org/api/function/hook_schema/6) и многие другие хуки Drupal, эта функция должна возвращать ассоциативный массив, на этот раз содержащий информацию о параметрах создаваемой формы. Здесь мы создаем три однострочных текстовых поля (параметр _#type_ имеет значение _textfield_), значения по умолчанию для которых (параметр _#default_value_) будут храниться и выбираться из стандартной таблицы variables Drupal при помощи функций [variable_set()](http://api.drupal.org/api/function/variable_set/6) и [variable_get()](http://api.drupal.org/api/function/variable_get/6). Благодаря использованию функций [drupal_get_form](http://api.drupal.org/api/function/drupal_get_form/6) и [system_settings_form](http://api.drupal.org/api/function/system_settings_form/6) нет необходимости заботиться о создании кнопок Submit и Reset, а также о функциях, обрабатывающих и сохраняющих данные формы. В более сложных случаях, которые будут рассмотрены в следующей статье, придется вручную создавать функции проверки введенных пользователем значений и сохранения данных. Подробное описание типов полей, используемых в формах, [можно найти в документации](http://api.drupal.org/api/file/developer/topics/forms_api_reference.html/6).

Все, мы завершили разработку первой из трех частей нашего модуля — административного интерфейса и переходим к разработке второй его части — инструмента получения данных от удаленного сервера.

Ссылки на другие части этой статьи:

- [Часть 1. Основы модульной системы Друпала]({{< relref "drupal-article-2-part-1-drupal-develop-module-vvedenie" >}})
- **Часть 2. Разработка простейшего модуля**
- [Часть 3. Введение в темизацию Друпала (для программистов, а не дизайнеров)]({{< relref "drupal-article-2-part-3-drupal-develop-module-cron-and-themeing" >}})

Содержание всех статей: [/blog/2010/my-drupal-articles]({{< relref "my-drupal-articles" >}})