---
title: Авторизация на Drupal-сайте с помощью аккаунта ВКонтакте
date: 2010-05-17 00:26:54 +0400
draft: false
tags: [old-site, Drupal, вКонтакте, OpenAPI]
deprecated: true
---
Разработчики [ВКонтакте.ру](http://vkontakte.ru) [не так давно](http://habrahabr.ru/company/vkontakte/blog/91347/) открыли доступ к [OpenAPI](http://vkontakte.ru/pages.php?o=-1&p=Open%20API) — интерфейсу, позволяющему обычным пользователям авторизоваться на сторонних сайтах с использованием своих учетных записей ВКонтакте.ру.

Я выкладываю первую версию модуля vk_openapi, который интегрирует Drupal 6 с Open API. Демонстрацию работы модуля вы можете увидеть на этом сайте. Кнопка для авторизации с помощью учетной записи вКонтакте находится в форме авторизации (в правой колонке внизу) и на странице с `формой входа`.

## Особенности модуля
 - из учетной записи ВКонтакте выбираются все доступные поля и сохраняются в объекте $user;
 - каждому созданному модулем пользователю автоматически может быть назначена роль;
 - в качестве аватара нового пользователя может быть использован автар из профиля пользователя ВКонтакте;
 - созданный модулем пользователь может быть связан с существующим на сайте аккаунтом.

В ближайших планах: обновление статуса пользователя на основе данных из профиля ВКонтакте.

Скачать модуль можно на [drupal.org](http://drupal.org/project/vk_openapi). В продолжении более подробное описание модуля и инструкция по его установке.
<!--more-->
## Работа модуля
Это пока первая и очень простая реализация модуля, работает он так:

1. после нажатия пользователем кнопки "войти вКонтакте" модуль получает необходимые данные от сервера вКонтакте.
2. Далее модуль проверяет есть ли в базе данных Друпала пользователь, связанный с именем, полученным от вКонтакте:
   - если его нет, то создается новый пользователь и связывается с id пользователя ВКонтакте. **Внимание!** Важная деталь. Если в базе данных есть пользователь с именем не связанным с учетной записью вКонтакте и из вКонтакте приходит пользователь с таким же именем, то такие две учетные записи не будут связаны, для имени нового пользователя будет просто добавлен суффикс _N, где вместо N будет подставлено число.
   - если связанный с учетной записью ВКонтакте пользователь есть, то будет использована найденная учетная запись.
3. Выбранный пользователь авторизуется в системе.
4. ВКонтакте не отдает адрес электронной почты, по этому модуль предлагает новому пользователю указать свой e-mail в настройках своего нового аккаунта.

## Установка и настройка модуля

1. Первым делом во ВКонтакте нужно создать приложение типа "Веб-сайт", для этого нужно перейти по ссылке: http://vkontakte.ru/pages.php?act=developers и нажать на кнопку "Подключить сайт".
2. В настройках созданного приложения нужно указать адрес сайта (http://example.com/) и базовый домен (example.com),  а также получить ID приложения и защищенный ключ, все эти четыре параметра нужно будет указать в настройках модуля vk_openapi.
3. Теперь нужно {{< resource "vk_openapi.zip" "скачать модуль" >}}, если вы этого еще не сделали, распаковать в папку _sites/all/modules_ и включить его стандартными средствами Друпала.
4. После активации модуля, на странице admin/settings/vk_openapi вы должны указать параметры созданного ранее приложения ВКонтакте.
5. Все, после выполнения этих действий к формам авторизации будет добавлена кнопка "войти вКонтакте" и пользователи смогут авторизоваться на вашем сайте с помощью учетных записей вКонтакте. При желании вы можете отключить вывод этой кнопки в формах авторизации, тогда в произвольное место страницы сайта нужно будет вставить код:
```
<div id="vk_login" class="vk_login" style="margin: 0 auto 20px auto;" onclick="doLogin();"></div>
```
который будет заменен на кнопку.

Я старался сделать этот модуль максимально простым для посетителей сайта — авторизоваться в системе можно всего одним кликом. Мне, например, сильно не нравится реализация [Facebook Connect](http://drupal.org/project/fbconnect) для Друпла тем, что после нажатия кнопки "Connect" пользователя заставляют еще заполнить некоторые поля в форме регистрации. По этому данные от ВКонтакте получаются только один раз, при первом входе в систему, и используются только имя и фамилия пользователя. Теоретически, эти данные можно периодически обновлять, также есть возможность получить данные о фотографиях пользователя и его аватарке, его друзьях изменениях статусов, связать логаут на Друпал-сайте с логаутом из ВКонтакте и т.п. Интересно знать нужен ли кому-нибудь подобный функционал или достаточно того, что уже есть сейчас?